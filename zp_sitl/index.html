<!DOCTYPE html>
<html>
<head>
    <title>ZeroPilot SITL</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/sebmatton/jQuery-Flight-Indicators@master/js/jquery.flightindicators.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sebmatton/jQuery-Flight-Indicators@master/css/flightindicators.css">
    <style>
        body { font-family: Arial; margin: 20px; background: #1e1e1e; color: #fff; }
        .container { max-width: 1200px; margin: 0 auto; position: relative; }
        .panel { background: #2d2d2d; padding: 20px; margin: 10px 0; border-radius: 8px; }
        .controls-panel { position: relative; }
        .controls { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .control-group { display: flex; flex-direction: column; }
        label { margin-bottom: 5px; font-weight: bold; }
        input[type="range"] { width: 100%; }
        .value { color: #4CAF50; font-size: 18px; }
        .state { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .state-item { text-align: center; padding: 10px; background: #3d3d3d; border-radius: 4px; }
        .instruments { display: flex; gap: 20px; justify-content: center; }
        .arm-btn { 
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 16px; 
            font-size: 14px; 
            font-weight: bold; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            transition: all 0.3s;
        }
        .arm-btn.disarmed { background: #4CAF50; color: white; }
        .arm-btn.armed { background: #d32f2f; color: white; }
        .arm-btn:hover { opacity: 0.8; }
        .startup-modal {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .startup-form {
            background: #2d2d2d;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
        }
        .startup-form h2 { margin-top: 0; text-align: center; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; }
        .form-group input[type="number"] { width: 100%; padding: 8px; background: #3d3d3d; border: 1px solid #555; color: #fff; border-radius: 4px; box-sizing: border-box; }
        .form-group input[type="checkbox"] { width: auto; margin-right: 8px; }
        .checkbox-label { display: flex; align-items: center; }
        .start-btn { width: 100%; padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .start-btn:hover { background: #45a049; }
        .hidden { display: none; }
        .joystick-status { font-size: 12px; color: #4CAF50; margin-top: 5px; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div id="startup-modal" class="startup-modal">
        <div class="startup-form">
            <h2>Initial Configuration</h2>
            <form id="startup-config">
                <div class="form-group">
                    <label>Altitude (ft)</label>
                    <input type="number" id="init-altitude" value="5000" step="100">
                </div>
                <div class="form-group">
                    <label>Airspeed (kts)</label>
                    <input type="number" id="init-speed" value="75" step="5">
                </div>
                <div class="form-group">
                    <label>Roll (degrees)</label>
                    <input type="number" id="init-roll" value="0" step="1">
                </div>
                <div class="form-group">
                    <label>Pitch (degrees)</label>
                    <input type="number" id="init-pitch" value="0" step="1">
                </div>
                <div class="form-group">
                    <label>Heading (degrees)</label>
                    <input type="number" id="init-heading" value="0" step="1">
                </div>
                <div class="form-group">
                    <label>Throttle (%)</label>
                    <input type="number" id="init-throttle" value="0" min="0" max="100">
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="init-engine" checked>
                        Start Armed
                    </label>
                </div>
                <button type="submit" class="start-btn">START SIMULATION</button>
            </form>
        </div>
    </div>

    <div class="container hidden" id="sim-container">
        <h1>ZeroPilot SITL - JSBSim</h1>
        
        <div class="panel">
            <h2>Aircraft State</h2>
            <div class="state">
                <div class="state-item">
                    <div>Roll</div>
                    <div class="value" id="roll">0&deg;</div>
                </div>
                <div class="state-item">
                    <div>Pitch</div>
                    <div class="value" id="pitch">0&deg;</div>
                </div>
                <div class="state-item">
                    <div>Yaw</div>
                    <div class="value" id="yaw">0&deg;</div>
                </div>
                <div class="state-item">
                    <div>Altitude</div>
                    <div class="value" id="altitude">0 ft</div>
                </div>
                <div class="state-item">
                    <div>Airspeed</div>
                    <div class="value" id="airspeed">0 kts</div>
                </div>
                <div class="state-item">
                    <div>RPM</div>
                    <div class="value" id="rpm">0</div>
                </div>
            </div>
        </div>

        <div class="panel">
            <h2>Flight Instruments</h2>
            <div class="instruments">
                <span id="attitude"></span>
                <span id="airspeed-indicator"></span>
                <span id="altimeter"></span>
            </div>
        </div>

        <div class="panel controls-panel">
            <button id="arm-btn" class="arm-btn disarmed">ARM</button>
            <h2>RC Channels</h2>
            <div id="joy-note" class="joystick-status" style="color: #888;">Joystick not detected. Move a stick or press a button to connect.</div>
            <div class="controls">
                <div class="control-group">
                    <label>Roll: <span id="roll-val">50</span></label>
                    <input type="range" id="roll-ctrl" min="0" max="100" value="50">
                    <div style="font-size: 12px; color: #888;">Motor: <span id="roll-out">50</span></div>
                </div>
                <div class="control-group">
                    <label>Pitch: <span id="pitch-val">50</span></label>
                    <input type="range" id="pitch-ctrl" min="0" max="100" value="50">
                    <div style="font-size: 12px; color: #888;">Motor: <span id="pitch-out">50</span></div>
                </div>
                <div class="control-group">
                    <label>Yaw: <span id="yaw-val">50</span></label>
                    <input type="range" id="yaw-ctrl" min="0" max="100" value="50">
                    <div style="font-size: 12px; color: #888;">Motor: <span id="yaw-out">50</span></div>
                </div>
                <div class="control-group">
                    <label>Throttle: <span id="throttle-val">0</span></label>
                    <input type="range" id="throttle-ctrl" min="0" max="100" value="0">
                    <div style="font-size: 12px; color: #888;">Motor: <span id="throttle-out">0</span></div>
                </div>
            </div>
        </div>

        <div class="panel">
            <h2>Telemetry Viewer</h2>
            <div style="display: flex; gap: 20px;">
                <div style="flex: 1;">
                    <h3>Transmitted</h3>
                    <div id="telem-tx" style="height: 300px; overflow-y: auto; background: #3d3d3d; padding: 10px; border-radius: 4px;"></div>
                </div>
                <div style="flex: 1;">
                    <h3>Received</h3>
                    <div id="telem-rx" style="height: 300px; overflow-y: auto; background: #3d3d3d; padding: 10px; border-radius: 4px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let attitude, airspeedIndicator, altimeter;
        let ws;

        $(document).ready(function() {
            document.getElementById('startup-config').addEventListener('submit', (e) => {
                e.preventDefault();
                const config = {
                    altitude: parseFloat(document.getElementById('init-altitude').value),
                    speed: parseFloat(document.getElementById('init-speed').value),
                    roll: parseFloat(document.getElementById('init-roll').value),
                    pitch: parseFloat(document.getElementById('init-pitch').value),
                    heading: parseFloat(document.getElementById('init-heading').value),
                    throttle: parseFloat(document.getElementById('init-throttle').value),
                    engine: document.getElementById('init-engine').checked
                };
                
                document.getElementById('startup-modal').classList.add('hidden');
                document.getElementById('sim-container').classList.remove('hidden');
                
                initSimulation(config);
            });

            startRFDViewer();
        });

        function initSimulation(config) {
            attitude = $.flightIndicator('#attitude', 'attitude', {
                size:200, 
                img_directory: 'https://cdn.jsdelivr.net/gh/sebmatton/jQuery-Flight-Indicators@master/img/'
            });
            airspeedIndicator = $.flightIndicator('#airspeed-indicator', 'airspeed', {
                size:200,
                img_directory: 'https://cdn.jsdelivr.net/gh/sebmatton/jQuery-Flight-Indicators@master/img/'
            });
            altimeter = $.flightIndicator('#altimeter', 'altimeter', {
                size:200,
                img_directory: 'https://cdn.jsdelivr.net/gh/sebmatton/jQuery-Flight-Indicators@master/img/'
            });

            ws = new WebSocket('ws://localhost:8080/ws');
            
            ws.onopen = () => {
                console.log('WebSocket connected');
                ws.send(JSON.stringify({type: 'init', config: config}));
            };
            ws.onerror = (e) => console.error('WebSocket error:', e);
            
            const controls = {
                roll: document.getElementById('roll-ctrl'),
                pitch: document.getElementById('pitch-ctrl'),
                yaw: document.getElementById('yaw-ctrl'),
                throttle: document.getElementById('throttle-ctrl')
            };

            // Set initial throttle
            controls.throttle.value = config.throttle;
            document.getElementById('throttle-val').textContent = config.throttle;

            // --- JOYSTICK LOGIC START ---
            let joystickConnected = false;

            window.addEventListener("gamepadconnected", (e) => {
                console.log("Gamepad connected at index %d: %s. %d buttons, %d axes.",
                    e.gamepad.index, e.gamepad.id,
                    e.gamepad.buttons.length, e.gamepad.axes.length);
                joystickConnected = true;
                document.getElementById('joy-note').textContent = "Joystick Connected: " + e.gamepad.id;
                document.getElementById('joy-note').style.color = "#4CAF50";
                pollJoystick();
            });

            window.addEventListener("gamepaddisconnected", (e) => {
                joystickConnected = false;
                document.getElementById('joy-note').textContent = "Joystick Disconnected.";
                document.getElementById('joy-note').style.color = "#d32f2f";
            });

            function pollJoystick() {
                if (!joystickConnected) return;
                const gamepads = navigator.getGamepads();
                const gp = gamepads[0];
                if (!gp) return;

                // Deadzone and Normalization
                const applyDeadzone = (val) => (Math.abs(val) < 0.05 ? 0 : val);
                const norm = (val) => Math.round((val + 1) * 50);

                // Axis mapping
                const joyData = {
                    roll: norm(applyDeadzone(gp.axes[2])),
                    pitch: norm(applyDeadzone(gp.axes[3])),
                    yaw: norm(applyDeadzone(gp.axes[0])),
                    throttle: norm(applyDeadzone(-gp.axes[1]))
                };

                // Update UI elements
                Object.entries(joyData).forEach(([key, val]) => {
                    controls[key].value = val;
                    document.getElementById(`${key}-val`).textContent = val;
                });

                // Send to Server
                if (ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'control', ...joyData }));
                }

                requestAnimationFrame(pollJoystick);
            }
            // --- JOYSTICK LOGIC END ---

            document.getElementById('arm-btn').addEventListener('click', () => {
                if (ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({type: 'arm'}));
                }
            });

            Object.entries(controls).forEach(([name, elem]) => {
                elem.addEventListener('input', () => {
                    // Only manual slider move sends this; joystick has its own loop
                    if (!joystickConnected) {
                        document.getElementById(`${name}-val`).textContent = elem.value;
                        if (ws.readyState === WebSocket.OPEN) {
                            ws.send(JSON.stringify({
                                type: 'control',
                                roll: parseInt(controls.roll.value),
                                pitch: parseInt(controls.pitch.value),
                                yaw: parseInt(controls.yaw.value),
                                throttle: parseInt(controls.throttle.value)
                            }));
                        }
                    }
                });
            });

            setInterval(() => {
                if (ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({type: 'state'}));
                }
            }, 100);

            ws.onmessage = (event) => {
                const state = JSON.parse(event.data);
                document.getElementById('roll').textContent = state.roll.toFixed(1) + '\u00B0';
                document.getElementById('pitch').textContent = state.pitch.toFixed(1) + '\u00B0';
                document.getElementById('yaw').textContent = state.yaw.toFixed(1) + '\u00B0';
                document.getElementById('altitude').textContent = state.altitude.toFixed(0) + ' ft';
                document.getElementById('airspeed').textContent = state.airspeed.toFixed(1) + ' kts';
                document.getElementById('rpm').textContent = state.rpm.toFixed(0);
                
                document.getElementById('roll-out').textContent = state.roll_output.toFixed(1);
                document.getElementById('pitch-out').textContent = state.pitch_output.toFixed(1);
                document.getElementById('yaw-out').textContent = state.yaw_output.toFixed(1);
                document.getElementById('throttle-out').textContent = state.throttle_output.toFixed(1);
                
                // Update arm button
                const armBtn = document.getElementById('arm-btn');
                if (state.armed) {
                    armBtn.textContent = 'DISARM';
                    armBtn.className = 'arm-btn armed';
                } else {
                    armBtn.textContent = 'ARM';
                    armBtn.className = 'arm-btn disarmed';
                }
                
                attitude.setRoll(-state.roll);
                attitude.setPitch(state.pitch);
                airspeedIndicator.setAirSpeed(state.airspeed);
                altimeter.setAltitude(state.altitude);
            };
        }

        function startRFDViewer() {
            const rfdWs = new WebSocket('ws://localhost:8080/rfd');
            const txDiv = document.getElementById('telem-tx');
            const rxDiv = document.getElementById('telem-rx');
            const MAX_MESSAGES = 1000;
            
            rfdWs.onmessage = (event) => {
                const data = JSON.parse(event.data);
                const div = data.direction === 1 ? txDiv : rxDiv;
                const msgElem = document.createElement('div');
                
                // Display decoded message if available, otherwise raw
                if (data.decoded) {
                    msgElem.innerHTML = `<strong>${data.type}</strong><br/><pre style="margin: 5px 0; font-size: 11px; color: #aaa;">${data.decoded}</pre>`;
                } else {
                    msgElem.textContent = data.raw;
                }
                
                msgElem.style.marginBottom = '10px';
                msgElem.style.padding = '8px';
                msgElem.style.background = '#1a1a1a';
                msgElem.style.borderRadius = '4px';
                div.insertBefore(msgElem, div.firstChild);
                
                // Remove oldest message if we exceed MAX_MESSAGES
                while (div.children.length > MAX_MESSAGES) {
                    div.removeChild(div.lastChild);
                }
            };
            
            rfdWs.onclose = () => console.log('RFD WebSocket closed');
        }
    </script>
</body>
</html>
